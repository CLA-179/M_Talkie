#include "Soft_i2c1.h"
#include "tim.h"

// ??????IIC
void IIC_Init(void)
{
	RCC->APB2ENR |= 1 << 3;	  // ????PORTB?��??
	GPIOB->CRL &= ~(3 << 28); // PB11????????
	GPIOB->CRL |= 1 << 28;
	GPIOB->CRL &= ~(3 << 24); // PB10????????
	GPIOB->CRL |= 1 << 24;
	GPIOB->CRL &= ~((uint32_t)3 << 30); // PB11????????
	GPIOB->CRL |= 1 << 30;
	GPIOB->CRL &= ~(3 << 26); // PB10????????
	GPIOB->CRL |= 1 << 26;
	IIC_SCL(1);
	IIC_SDA(1);
}
// ?��?��IIC????????
void IIC_Start(void)
{
	SDA1_OUT(); // sda??????
	IIC_SDA(1);
	IIC_SCL(1);
	delay_us(4);
	IIC_SDA(0); // START:when CLK is high,DATA change form high to low
	delay_us(4);
	IIC_SCL(0); // ??��?I2C��?????��?��?��????��????????
}
// ?��?��IIC????????
void IIC_Stop(void)
{
	SDA1_OUT(); // sda??????
	IIC_SCL(1);
	IIC_SDA(0); // STOP:when CLK is high DATA change form low to high
	delay_us(4);
	// IIC_SCL(1);
	delay_us(4);
	IIC_SDA(1); // ��???I2C��????��??????
}
// ????????????????
// ��???????1???????????���?
//         0??????????????
uint8_t IIC_Wait_Ack(void)
{
	// uint8_t ucErrTime = 0;
	SDA1_IN(); // SDA?��????????
	IIC_SDA(1);
	delay_us(1);
	IIC_SCL(1);
	delay_us(1);
	// while (READ_SDA1)
	// {
	// 	ucErrTime++;
	// 	if (ucErrTime > 250)
	// 	{
	// 		IIC_Stop();
	// 		return 1;
	// 	}
	// }
	IIC_SCL(0); // ?��??????0
	return 0;
}
// ?��?��ACK????
void IIC_Ack(void)
{
	IIC_SCL(0);
	SDA1_OUT();
	IIC_SDA(0);
	delay_us(2);
	IIC_SCL(1);
	delay_us(2);
	IIC_SCL(0);
	IIC_SDA(1);
}
// ???��?��ACK????
void IIC_NAck(void)
{
	IIC_SCL(0);
	SDA1_OUT();
	IIC_SDA(1);
	delay_us(2);
	IIC_SCL(1);
	delay_us(2);
	IIC_SCL(0);
}
// IIC��???????��???
// ��??????��????????
// 1????????
// 0????????
void IIC_Send_Byte(uint8_t txd)
{
	uint8_t t;
	SDA1_OUT();
	IIC_SCL(0); // ?????��??????????????
	for (t = 0; t < 8; t++)
	{
		IIC_SDA((txd & 0x80) >> 7);
		txd <<= 1;
		delay_us(2); // ?????????��????��?????
		IIC_SCL(1);
		delay_us(2);
		IIC_SCL(0);
		delay_us(2);
	}
}
// ??1??��?????ack=1?��??��???ACK??ack=0??��???nACK
uint8_t IIC_Read_Byte(unsigned char ack)
{
	unsigned char i, receive = 0;
	SDA1_IN(); // SDA?��????????
	for (i = 0; i < 8; i++)
	{
		IIC_SCL(0);
		delay_us(2);
		IIC_SCL(1);
		receive <<= 1;
		if (READ_SDA1)
			receive++;
		delay_us(1);
	}
	if (!ack)
		IIC_NAck(); // ��???nACK
	else
		IIC_Ack(); // ��???ACK
	return receive;
}

void Write_IIC_Command(uint8_t *command)
{
	IIC_Start();
	IIC_Send_Byte(0xEE);
	IIC_Wait_Ack();
	IIC_Send_Byte(*command); // ��????��??
	IIC_Wait_Ack();
	IIC_Stop();
}
void Read_IIC_Data(uint8_t *data, uint8_t count)
{
	uint8_t i = 0;
	IIC_Start();
	IIC_Send_Byte(0xEF);
	IIC_Wait_Ack();
	for (i = 0; i < count - 1; i++)
		data[i] = IIC_Read_Byte(1);
	data[i] = IIC_Read_Byte(0);
	IIC_Stop();
}
